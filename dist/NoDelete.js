function _(e){window.enmity.plugins.registerPlugin(e)}function f(e,i){return window.enmity.modules.getModule(e,i)}function l(...e){return window.enmity.modules.getByProps(...e)}window.enmity.modules.common;function h(e){return window.enmity.patcher.create(e)}var D="NoDelete",E="1.3.4",M='Basic "Message Logger"',v=[{name:"Marek (modified by spin)",id:"308440976723148800"}],w="#ff0069",S="https://raw.githubusercontent.com/spinfal/enmity-plugins/master/dist/NoDelete.js",N={name:D,version:E,description:M,authors:v,color:w,sourceUrl:S};function a(e){return window.enmity.assets.getIDByName(e)}const c=h("NoDelete"),r=f(e=>e.open!==void 0&&e.close!==void 0&&!e.openLazy&&!e.startDrag&&!e.init&&!e.openReplay&&!e.openChannelCallPopout),A={...N,patches:[],onStart(){let e=0,i=3;const d=()=>{try{e++;const s=l("_currentDispatchActionType","_subscriptions","_actionHandlers","_waitQueue"),g=l("getMessage","getMessages"),u=l("getChannel","getDMFromUserId");console.log(`NoDelete delayed start attempt ${e}/${i}.`),r.open({content:`NoDelete start attempt ${e}/${i}.`,source:a("debug")});for(const o of["MESSAGE_UPDATE","MESSAGE_DELETE"])try{s.dispatch({type:o,message:{}})}catch{}const m=s._actionHandlers._orderedActionHandlers.MESSAGE_DELETE.find(o=>o.name==="MessageStore"),p=s._actionHandlers._orderedActionHandlers.MESSAGE_UPDATE.find(o=>o.name==="MessageStore");c.before(m,"actionHandler",(o,t)=>{const n=g.getMessage(t[0].channelId,t[0].id);if(t[0]={},!(n!=null&&n.editedTimestamp)||(n==null?void 0:n.editedTimestamp._isValid)){const y={type:"MESSAGE_UPDATE",message:{...n,edited_timestamp:"invalid_timestamp",content:n.content+" `[deleted]`",guild_id:u.getChannel(n.channel_id).guild_id},log_edit:!1};s.dispatch(y)}}),c.before(p,"actionHandler",(o,t)=>{try{if(t[0].log_edit==!1)return;const n=g.getMessage(t[0].message.channel_id,t[0].message.id);try{if(!t[0].edited_timestamp._isValid)return}catch{}t[0].message.content=n.content.replace(/`\[edited\]`\n/gm,"")+" `[edited]`\n"+t[0].message.content;return}catch{}}),console.log("NoDelete delayed start successful."),r.open({content:"NoDelete delayed start successful.",source:a("Check")})}catch(s){console.log("[NoDelete Plugin Error]",s),e<i?(console.warn(`NoDelete failed to start. Trying again in ${e}0s.`),r.open({content:`NoDelete failed to start trying again in ${e}0s.`,source:a("ic_message_retry")}),setTimeout(d,e*1e4)):(console.error("NoDelete failed to start. Giving up."),r.open({content:"NoDelete failed to start. Giving up.",source:a("Small")}))}};setTimeout(()=>{d()},300)},onStop(){c.unpatchAll()}};_(A);
